!!!!!!!!!!!!!!!
rules:
  - id: tainted-sql-numeric-unquoted-medium
    languages: [php]
    severity: ERROR
    mode: taint

    message: |
      User-controlled data flows into an unquoted numeric SQL parameter.
      Using mysqli_real_escape_string() does not make this safe if the value
      is not quoted in the SQL string. This pattern matches DVWA-like
      medium-level SQL injection (e.g. `WHERE user_id = $id;`).

    metadata:
      cwe:
        - "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
      owasp:
        - A01:2017 - Injection
        - A03:2021 - Injection
      references:
        - https://owasp.org/www-community/attacks/SQL_Injection
      category: security
      technology: [php]
      subcategory: [vuln]
      likelihood: HIGH
      impact: MEDIUM
      confidence: MEDIUM
      dvwa-level: medium

    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: $_GET
              - pattern: $_POST
              - pattern: $_COOKIE
              - pattern: $_REQUEST

    pattern-propagators:
      - patterns:
          - pattern: $CLEAN = mysqli_real_escape_string(..., $DIRTY);

    pattern-sanitizers:
      - pattern-either:
          - pattern: $DB->prepare(...)
          - pattern: mysqli_prepare(...)

    pattern-sinks:
      - pattern-either:

          - patterns:
              - pattern: mysqli_query(..., $SQL)
              - metavariable-regex:
                  metavariable: $SQL
                  regex: (?is).*\b(select|delete|insert|update|alter|drop)\b.*=\s*\$[A-Za-z_][A-Za-z0-9_]*\b.*

          # 2) –û–±–æ–±—â—ë–Ω–Ω—ã–π $db->query($SQL)
          - patterns:
              - pattern: $DB->query($SQL)
              - metavariable-regex:
                  metavariable: $SQL
                  regex: (?is).*\b(select|delete|insert|update|alter|drop)\b.*=\s*\$[A-Za-z_][A-Za-z0-9_]*\b.*



  - id: tainted-sql-string-extended
  languages:
    - php
  severity: ERROR
  message: User data flows into this manually-constructed SQL string (including via
    string interpolation or concatenation) which is then executed as a query. This
    is a possible SQL injection. Use prepared statements instead of dynamic SQL.
  metadata:
    cwe:
      - "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
    owasp:
      - A01:2017 - Injection
      - A03:2021 - Injection
    references:
      - https://owasp.org/www-community/attacks/SQL_Injection
    category: security
    technology:
      - php
    cwe2022-top25: true
    cwe2021-top25: true
    subcategory:
      - vuln
    likelihood: HIGH
    impact: MEDIUM
    confidence: MEDIUM
  mode: taint

  # —Ç–µ –∂–µ "—Å–∞–Ω–∏—Ç–∞–π–∑–µ—Ä—ã", —á—Ç–æ –∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø—Ä–∞–≤–∏–ª–µ
  pattern-sanitizers:
    - pattern-either:
        - pattern: mysqli_real_escape_string(...)
        - pattern: real_escape_string(...)
        - pattern: $MYSQLI->real_escape_string(...)

  # üîπ –ò–°–¢–û–ß–ù–ò–ö–ò: –¥–æ–±–∞–≤–∏–ª–∏ —Å—é–¥–∞ –µ—â—ë –∏ $_SESSION
  pattern-sources:
    - patterns:
        - pattern-either:
            - pattern: $_GET
            - pattern: $_POST
            - pattern: $_COOKIE
            - pattern: $_REQUEST
            - pattern: $_SESSION

  # üîπ SINK-–∏: —Ä–µ–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL + —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
  pattern-sinks:
    - pattern-either:
        # 1) –ü—Ä—è–º–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL
        - pattern: mysqli_query(..., $SQL)
        - pattern: $DB->query($SQL)

        # 2) sprintf —Å SQL-—à–∞–±–ª–æ–Ω–æ–º
        - patterns:
            - pattern: |
                sprintf($SQLSTR, ...)
            - metavariable-regex:
                metavariable: $SQLSTR
                regex: (?is).*\b(select|delete|insert|create|update|alter|drop)\b.*

        # 3) –°—Ç—Ä–æ–∫–∞ —Å –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–µ–π —Ç–∞–∏–Ω—Ç–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–≤–∫–ª—é—á–∞—è "WHERE ... '$id'")
        - patterns:
            - pattern: |
                "...$EXPR..."
            - metavariable-regex:
                metavariable: $EXPR
                regex: (?is).*\b(select|delete|insert|create|update|alter|drop)\b.*

        # 4) –ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è "SQL" . $EXPR
        - patterns:
            - pattern: |
                "$SQLSTR".$EXPR
            - metavariable-regex:
                metavariable: $SQLSTR
                regex: (?is).*\b(select|delete|insert|create|update|alter|drop)\b.*
