rules:
  # 1) Захардкоженный ключ в define()
  - id: php-hardcoded-crypto-key-constant
    languages: [php]
    severity: WARNING
    message: Hardcoded cryptographic key found → $NAME = "$VALUE". Avoid embedding secrets in code. Use secure storage (env vars, vault, key manager).
    metadata:
      owasp: 'A02:2021 – Cryptographic Failures'
      project: DVWA(2)

    patterns:
      - pattern: |
          define("$NAME", "$VALUE");
      - metavariable-regex:
          metavariable: $NAME
          regex: '(?i)(key|secret|token|password|passwd|api[_-]?key|hmac|auth|master)'



  # 2) Захардкоженный ключ в обычном присваивании
  - id: php-hardcoded-crypto-key-assignment
    languages: [php]
    severity: WARNING
    message: "Hardcoded cryptographic key assignment detected: $VAR = $VALUE"

    metadata:
      owasp: ['A02:2021 – Cryptographic Failures']


    patterns:
      - pattern: |
          $VAR = $VALUE;
      - metavariable-regex:
          metavariable: $VAR
          regex: '(?i)(\$?(key|secret|token|password|passwd|api[_-]?key|hmac|auth|master))'
      - metavariable-regex:
          metavariable: $VALUE
          regex: >
            ^["'][^"']*["']$

  # 3) Захардкоженный IV через define()
  - id: php-hardcoded-crypto-iv-constant
    languages: [php]
    severity: WARNING
    message: "Hardcoded IV constant detected: $NAME = $VALUE"
    metadata:
      owasp: ['A02:2021 – Cryptographic Failures']
      project: DVWA(1)

    patterns:
      - pattern: |
          define("$NAME", "$VALUE");
      - metavariable-regex:
          metavariable: $NAME
          regex: '(?i)(iv|nonce|initial[_-]?vector)'


   # 4) Статический IV в AES-CBC (литерал IV в вызове openssl)
  - id: openssl-cbc-static-iv
    languages: [php]
    severity: ERROR
    message: Static IV used with AES-CBC. This is insecure and enables attacks on confidentiality and integrity

    metadata:
      owasp: ['A02:2021 – Cryptographic Failures']


    patterns:
      - pattern-either:
          - pattern: |
              openssl_encrypt($D, $M, $K, $FLAGS, $IV, ...);
          - pattern: |
              openssl_decrypt($D, $M, $K, $FLAGS, $IV, ...);
      - metavariable-regex:
          metavariable: $M
          regex: '(?i)aes-(128|192|256)-cbc'
      - metavariable-regex:
          metavariable: $IV
          regex: >
            ^["'][^"']*["']$
