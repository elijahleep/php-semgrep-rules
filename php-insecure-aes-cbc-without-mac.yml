rules:
  # 1) AES-CBC без MAC/AEAD — алгоритм указан строкой
  - id: php-insecure-aes-cbc-without-mac-literal
    severity: WARNING
    languages: [php]
    message: Insecure AES-CBC mode used without MAC/AEAD. This may allow padding-oracle and integrity attacks.
    metadata:
      owasp: "A02:2021 – Cryptographic Failures"


    patterns:
      - pattern-either:
          - pattern: |
              $C = openssl_encrypt($DATA, "$ALGO", $KEY, $OPTS, $IV, ...);
          - pattern: |
              $P = openssl_decrypt($DATA, "$ALGO", $KEY, $OPTS, $IV, ...);
      - metavariable-regex:
          metavariable: $ALGO
          regex: "(?i)aes-(128|192|256)-cbc"

      - pattern-not: |
          $MAC = hash_hmac(...);

      - pattern-not: |
          if (hash_equals($MAC, ...)) { ... }

      - pattern-not: |
          $C = sodium_crypto_aead_chacha20poly1305_encrypt(...);

      - pattern-not: |
          $P = sodium_crypto_aead_chacha20poly1305_decrypt(...);



    # 2) AES-CBC без MAC/AEAD — константа = "aes-*-cbc"
  - id: php-insecure-aes-cbc-without-mac-const-algo
    severity: WARNING
    languages: [php]
    message: Insecure AES-CBC mode used via ALGO constant without MAC/AEAD.
    metadata:
      owasp: "A02:2021 – Cryptographic Failures"
      project: DVWA(1)



    patterns:
      - pattern-either:
          - pattern: |
              define("ALGO", "$ALGOVAL");
              ...
              $C = openssl_encrypt($DATA, ALGO, $KEY, $OPTS, $IV, ...);
          - pattern: |
              define("ALGO", "$ALGOVAL");
              ...
              $P = openssl_decrypt($DATA, ALGO, $KEY, $OPTS, $IV, ...);
      - metavariable-regex:
          metavariable: $ALGOVAL
          regex: "(?i)aes-(128|192|256)-cbc"

      # 3) Те же pattern-not, чтобы отсечь MAC/AEAD
      - pattern-not: |
          $MAC = hash_hmac(...);

      - pattern-not: |
          if (hash_equals($MAC, ...)) { ... }

      - pattern-not: |
          $C = sodium_crypto_aead_chacha20poly1305_encrypt(...);

      - pattern-not: |
          $P = sodium_crypto_aead_chacha20poly1305_decrypt(...);