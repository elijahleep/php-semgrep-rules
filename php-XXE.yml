rules:
  - id: php-xxe-untrusted-xml
    languages: [php]
    severity: ERROR
    mode: taint
    message: Untrusted XML data flows into DOMDocument XML parsing with external entities enabled. This may lead to XXE (XML External Entity) attacks and disclosure of local files or SSRF.
    metadata:
      owasp: "A03:2021 â€“ Injection"
      project: "BVCS(2)"

    pattern-sources:
      - pattern: $_GET[$KEY]
      - pattern: $_POST[$KEY]
      - pattern: $_REQUEST[$KEY]
      - pattern: file_get_contents("php://input")

    pattern-sanitizers:
      - pattern: libxml_disable_entity_loader(true)

    pattern-sinks:
      - pattern-either:
          - patterns:
              - pattern: $DOC->loadXML($XML, $OPTS)
              - metavariable-regex:
                  metavariable: $OPTS
                  regex: .*LIBXML_NOENT|LIBXML_DTDLOAD.*
          - patterns:
              - pattern: libxml_disable_entity_loader(false); ...
              - pattern: $DOC->loadXML($XML)
