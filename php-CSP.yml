rules:
  - id: php-csp-low-external-script-whitelist
    languages: [php]
    severity: ERROR
    message: >
      CSP allows scripts from external domains, and user-controlled input is used
      as the <script src="..."> URL. This matches the DVWA CSP "low" level and
      may allow loading attacker-controlled JavaScript.
    metadata:
      category: security
      technology: [php]
      dvwa-level: csp-low
      cwe:
        - "CWE-116: Improper Output Neutralization for Web Page Generation ('XSS')"
      owasp_top_10:
        - "A05:2021 - Security Misconfiguration"
      confidence: MEDIUM
      likelihood: HIGH
      impact: HIGH

    patterns:
      # в файле должен использоваться $_POST (user-controlled input)
      - pattern: $_POST

      # и генериться тег <script src='...'>
      - pattern: $page['body'] .= "<script src='" . $URL . "'></script>";

      # и где-то выше должен настраиваться CSP-хедер
      - pattern-inside: |
          $headerCSP = $CONF;
          header($headerCSP);

      # а сам CSP должен разрешать внешние домены
      - metavariable-regex:
          metavariable: $CONF
          regex: (?i)Content-Security-Policy:.*script-src.*(pastebin\.com|hastebin\.com|toptal\.com|example\.com|code\.jquery\.com|digi\.ninja)



  - id: php-csp-medium-unsafe-inline-with-user-html
    languages: [php]
    severity: ERROR
    message: >
      CSP uses 'unsafe-inline' and a fixed nonce, while user-controlled HTML is
      injected directly into the page. This effectively disables CSP XSS protection
      and matches the DVWA CSP "medium" level.
    metadata:
      category: security
      technology: [php]
      dvwa-level: csp-medium
      cwe:
        - "CWE-116: Improper Output Neutralization for Web Page Generation ('XSS')"
      owasp_top_10:
        - "A05:2021 - Security Misconfiguration"
      confidence: MEDIUM
      likelihood: HIGH
      impact: HIGH

    patterns:
      # где-то используется $_POST (user-controlled HTML)
      - pattern: $_POST

      # и он включается в body страницы
      - pattern: |
          $page['body'] .= "
            " . $INCLUDE . "
          ";

      # а в том же контексте есть CSP с 'unsafe-inline'
      - pattern-inside: |
          $headerCSP = $CSP;
          header($headerCSP);

      - metavariable-regex:
          metavariable: $CSP
          regex: (?i)Content-Security-Policy:.*script-src.*'unsafe-inline'
