rules:
  - id: tainted-sql-numeric-unquoted-medium
    languages: [php]
    severity: ERROR
    mode: taint
    message: |
      User-controlled data flows into an unquoted numeric SQL parameter.
      Using mysqli_real_escape_string() does not make this safe if the value
      is not quoted in the SQL string. This pattern matches DVWA-like
      medium-level SQL injection (e.g. `WHERE user_id = $id;`).

    metadata:
      owasp: A03:2021 - Injection
      project: DVWA(1)

    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: $_GET
              - pattern: $_POST
              - pattern: $_COOKIE
              - pattern: $_REQUEST
              - pattern: $_GET[...]
              - pattern: $_POST[...]
              - pattern: $_COOKIE[...]
              - pattern: $_REQUEST[...]

    pattern-propagators:
      - pattern: $CLEAN = mysqli_real_escape_string(..., $DIRTY);
        from: $DIRTY
        to: $CLEAN

    pattern-sanitizers:
      - pattern-either:
          - pattern: $DB->prepare(...)
          - pattern: mysqli_prepare(...)

    pattern-sinks:
      - pattern-either:
          # SQL строится с unquoted numeric
          - patterns:
              - pattern: $SQL = " ... WHERE user_id = $ID ... ";
              - metavariable-regex:
                  metavariable: $SQL
                  regex: (?is).*\bwhere\b.*\buser_id\b\s*=\s*\$[A-Za-z_][A-Za-z0-9_]*\b.*
          # и/или выполнение
          - pattern: mysqli_query(..., $SQL)
          - pattern: $DB->query($SQL)



  - id: tainted-sql-string-extended
    languages:
      - php
    severity: ERROR
    message: User data flows into this manually-constructed SQL string (including via
      string interpolation or concatenation) which is then executed as a query. This
      is a possible SQL injection. Use prepared statements instead of dynamic SQL.
    mode: taint

    metadata:
      owasp: A03:2021 - Injection
      project: DVWA(1) sql_labs(1)

    pattern-sanitizers:
      - pattern-either:
          - pattern: $DB->prepare(...)
          - pattern: mysqli_prepare(...)

    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern: $_GET
              - pattern: $_POST
              - pattern: $_COOKIE
              - pattern: $_REQUEST
              - pattern: $_SESSION
              - pattern: $_GET[...]
              - pattern: $_POST[...]
              - pattern: $_COOKIE[...]
              - pattern: $_REQUEST[...]
              - pattern: $_SESSION[...]

    pattern-sinks:
      - pattern-either:
          # 1) Прямое выполнение SQL
          - pattern: mysqli_query(..., $SQL)
          - pattern: $DB->query($SQL)

          # 2) sprintf с SQL-шаблоном
          - patterns:
              - pattern: |
                  sprintf($SQLSTR, ...)
              - metavariable-regex:
                  metavariable: $SQLSTR
                  regex: (?is).*\b(select|delete|insert|create|update|alter|drop)\b.*

          # 3) Строка с интерполяцией таинтовой переменной (включая "WHERE ... '$id'")
          - patterns:
              - pattern: |
                  "...$EXPR..."
              - metavariable-regex:
                  metavariable: $EXPR
                  regex: (?is).*\b(select|delete|insert|create|update|alter|drop)\b.*

          # 4) Конкатенация "SQL" . $EXPR
          - patterns:
              - pattern: |
                  "$SQLSTR".$EXPR
              - metavariable-regex:
                  metavariable: $SQLSTR
                  regex: (?is).*\b(select|delete|insert|create|update|alter|drop)\b.*
